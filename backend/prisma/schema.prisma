generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String          @id @default(cuid())
  name                String
  email               String          @unique
  passwordHash        String
  role                UserRole        @default(DOCTOR)
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  createdCarePlans    CarePlan[]      @relation("CarePlanCreator")
  consultations       Consultation[]
  sentEmails          EmailHistory[]  @relation("EmailHistorySender")
  createdReminders    EmailReminder[] @relation("EmailReminderCreator")
  uploadedScalpPhotos   ScalpPhoto[]
  createdEmailTemplates EmailTemplate[]
  refreshTokens         RefreshToken[]
  pdfJobs               PdfJob[]        @relation("PdfJobRequestor")
  auditLogs             AuditLog[]

  @@index([email])
}

model Patient {
  id            String          @id @default(cuid())
  firstName     String
  lastName      String
  age           Int?
  gender        Gender?
  occupation    String?
  address       String?
  phone         String?
  email         String?
  isArchived    Boolean         @default(false)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  carePlans     CarePlan[]
  consultations Consultation[]
  emailHistory  EmailHistory[]
  reminders     EmailReminder[]
  labResults    LabResult[]
  scalpPhotos   ScalpPhoto[]

  @@index([firstName, lastName])
  @@index([phone])
  @@index([email])
  @@index([isArchived])
}

model Consultation {
  id                            String         @id @default(cuid())
  patientId                     String
  doctorId                      String
  consultationDate              DateTime       @default(now())
  hairLossSeverity              String?
  hairLossDuration              String?
  hairLossShampoos              String?
  oilyHairSeverity              String?
  oilyHairWashingFreq           String?
  oilyHairDuration              String?
  oilyHairShampoos              String?
  oilyHairNotes                 String?
  scalingSeverity               String?
  scalingDuration               String?
  sensitivitySeverity           String?
  sensitivityDuration           String?
  inflammatoryStates            String?
  familyHistory                 String?
  dermatologyVisits             String?
  pregnancy                     String?
  menstruationRegularity        String?
  contraception                 String?
  medications                   String?
  supplements                   String?
  stressLevel                   String?
  anesthesia                    String?
  chemotherapy                  String?
  radiotherapy                  String?
  vaccination                   String?
  antibiotics                   String?
  chronicDiseases               String?
  specialists                   String?
  eatingDisorders               String?
  foodIntolerances              String?
  diet                          String?
  allergies                     String?
  metalPartsInBody              String?
  careRoutineShampoo            String?
  careRoutineConditioner        String?
  careRoutineOils               String?
  careRoutineChemical           String?
  hyperhidrosis                 String?
  hyperkeratinization           String?
  sebaceousSecretion            String?
  scalpPH                       String?
  hairQuality                   String?
  hairShape                     String?
  regrowingHairs                String?
  degreeOfThinning              String?
  miniaturization               String?
  follicularUnits               String?
  pullTest                      String?
  alopeciaOther                 String?
  diagnosis                     String?
  careRecommendationsWashing    String?
  careRecommendationsTopical    String?
  careRecommendationsSupplement String?
  careRecommendationsBehavior   String?
  visitsProcedures              String?
  generalRemarks                String?
  norwoodHamiltonStage          String?
  norwoodHamiltonNotes          String?
  ludwigStage                   String?
  ludwigNotes                   String?
  isArchived                    Boolean        @default(false)
  createdAt                     DateTime       @default(now())
  updatedAt                        DateTime       @updatedAt
  alopeciaAffectedAreas         Json?
  alopeciaType                  String?
  chronicDiseasesList           String?
  dermatologyVisitsReason       String?
  medicationsList               String?
  scalingOther                  String?
  scalpDiseases                 Json?
  seborrheaTypeOther            String?
  sensitivityOther              String?
  specialistsList               String?
  hairLossLocalization          Json?
  scalingType                   Json?
  sensitivityProblemType        Json?
  scalpType                     Json?
  scalpAppearance               Json?
  skinLesions                   Json?
  seborrheaType                 Json?
  dandruffType                  Json?
  hairDamage                    Json?
  hairDamageReason              Json?
  hairTypes                     Json?
  vellusMiniaturizedHairs       Json?
  vascularPatterns              Json?
  perifollicularFeatures        Json?
  otherDiagnostics              Json?
  alopeciaTypes                 Json?
  carePlans                     CarePlan[]
  doctor                        User           @relation(fields: [doctorId], references: [id])
  patient                       Patient        @relation(fields: [patientId], references: [id], onDelete: Cascade)
  emailHistory                  EmailHistory[]
  labResults                    LabResult[]
  scalpPhotos                   ScalpPhoto[]
  pdfJobs                       PdfJob[]

  @@index([patientId])
  @@index([doctorId])
  @@index([consultationDate])
  @@index([isArchived])
}

model LabResult {
  id                  String        @id @default(cuid())
  patientId           String
  consultationId      String?
  date                DateTime      @default(now())
  hgb                 Float?
  hgbUnit             String?
  hgbRefLow           Float?
  hgbRefHigh          Float?
  hgbFlag             String?
  rbc                 Float?
  rbcUnit             String?
  rbcRefLow           Float?
  rbcRefHigh          Float?
  rbcFlag             String?
  wbc                 Float?
  wbcUnit             String?
  wbcRefLow           Float?
  wbcRefHigh          Float?
  wbcFlag             String?
  plt                 Float?
  pltUnit             String?
  pltRefLow           Float?
  pltRefHigh          Float?
  pltFlag             String?
  crp                 Float?
  crpUnit             String?
  crpRefLow           Float?
  crpRefHigh          Float?
  crpFlag             String?
  iron                Float?
  ironUnit            String?
  ironRefLow          Float?
  ironRefHigh         Float?
  ironFlag            String?
  ferritin            Float?
  ferritinUnit        String?
  ferritinRefLow      Float?
  ferritinRefHigh     Float?
  ferritinFlag        String?
  vitaminD3           Float?
  vitaminD3Unit       String?
  vitaminD3RefLow     Float?
  vitaminD3RefHigh    Float?
  vitaminD3Flag       String?
  vitaminB12          Float?
  vitaminB12Unit      String?
  vitaminB12RefLow    Float?
  vitaminB12RefHigh   Float?
  vitaminB12Flag      String?
  folicAcid           Float?
  folicAcidUnit       String?
  folicAcidRefLow     Float?
  folicAcidRefHigh    Float?
  folicAcidFlag       String?
  tsh                 Float?
  tshUnit             String?
  tshRefLow           Float?
  tshRefHigh          Float?
  tshFlag             String?
  ft3                 Float?
  ft3Unit             String?
  ft3RefLow           Float?
  ft3RefHigh          Float?
  ft3Flag             String?
  ft4                 Float?
  ft4Unit             String?
  ft4RefLow           Float?
  ft4RefHigh          Float?
  ft4Flag             String?
  antiTPO             Float?
  antiTPOUnit         String?
  antiTPORefLow       Float?
  antiTPORefHigh      Float?
  antiTPOFlag         String?
  antiTG              Float?
  antiTGUnit          String?
  antiTGRefLow        Float?
  antiTGRefHigh       Float?
  antiTGFlag          String?
  trab                Float?
  trabUnit            String?
  trabRefLow          Float?
  trabRefHigh         Float?
  trabFlag            String?
  estrogen            Float?
  estrogenUnit        String?
  estrogenRefLow      Float?
  estrogenRefHigh     Float?
  estrogenFlag        String?
  progesterone        Float?
  progesteroneUnit    String?
  progesteroneRefLow  Float?
  progesteroneRefHigh Float?
  progesteroneFlag    String?
  testosterone        Float?
  testosteroneUnit    String?
  testosteroneRefLow  Float?
  testosteroneRefHigh Float?
  testosteroneFlag    String?
  dheas               Float?
  dheasUnit           String?
  dheasRefLow         Float?
  dheasRefHigh        Float?
  dheasFlag           String?
  prolactin           Float?
  prolactinUnit       String?
  prolactinRefLow     Float?
  prolactinRefHigh    Float?
  prolactinFlag       String?
  glucose             Float?
  glucoseUnit         String?
  glucoseRefLow       Float?
  glucoseRefHigh      Float?
  glucoseFlag         String?
  insulin             Float?
  insulinUnit         String?
  insulinRefLow       Float?
  insulinRefHigh      Float?
  insulinFlag         String?
  homaIR              Float?
  homaIRRefLow        Float?
  homaIRRefHigh       Float?
  homaIRFlag          String?
  hba1c               Float?
  hba1cUnit           String?
  hba1cRefLow         Float?
  hba1cRefHigh        Float?
  hba1cFlag           String?
  notes               String?
  isArchived          Boolean       @default(false)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  consultation        Consultation? @relation(fields: [consultationId], references: [id])
  patient             Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([consultationId])
  @@index([date])
}

model ScalpPhoto {
  id               String                 @id @default(cuid())
  patientId        String
  consultationId   String?
  uploadedByUserId String
  filePath         String
  originalFilename String
  mimeType         String
  notes            String?
  createdAt        DateTime               @default(now())
  consultation     Consultation?          @relation(fields: [consultationId], references: [id])
  patient          Patient                @relation(fields: [patientId], references: [id], onDelete: Cascade)
  uploadedBy       User                   @relation(fields: [uploadedByUserId], references: [id])
  annotations      ScalpPhotoAnnotation[]

  @@index([patientId])
  @@index([consultationId])
  @@index([createdAt])
}

model ScalpPhotoAnnotation {
  id           String         @id @default(cuid())
  scalpPhotoId String
  type         AnnotationType @default(PROBLEM_AREA)
  shapeType    ShapeType
  coordinates  Json
  label        String
  createdAt    DateTime       @default(now())
  scalpPhoto   ScalpPhoto     @relation(fields: [scalpPhotoId], references: [id], onDelete: Cascade)

  @@index([scalpPhotoId])
}

model CarePlan {
  id                 String          @id @default(cuid())
  patientId          String
  consultationId     String?
  createdByUserId    String
  title              String
  totalDurationWeeks Int
  notes              String?
  isActive           Boolean         @default(true)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  consultation       Consultation?   @relation(fields: [consultationId], references: [id])
  createdBy          User            @relation("CarePlanCreator", fields: [createdByUserId], references: [id])
  patient            Patient         @relation(fields: [patientId], references: [id], onDelete: Cascade)
  weeks              CarePlanWeek[]
  emailHistory       EmailHistory[]
  reminders          EmailReminder[]
  pdfJobs            PdfJob[]
  isArchived         Boolean         @default(false)

  @@index([patientId])
  @@index([consultationId])
  @@index([isActive])
}

model CarePlanWeek {
  id                 String   @id @default(cuid())
  carePlanId         String
  weekNumber         Int
  description        String?
  washingRoutine     String?
  topicalProducts    String?
  supplements        String?
  inClinicProcedures String?
  remarks            String?
  carePlan           CarePlan @relation(fields: [carePlanId], references: [id], onDelete: Cascade)

  @@unique([carePlanId, weekNumber])
  @@index([carePlanId])
}

model EmailReminder {
  id              String         @id @default(cuid())
  patientId       String
  carePlanId      String?
  createdByUserId String
  type            ReminderType
  sendAt          DateTime
  status          ReminderStatus @default(PENDING)
  subject         String
  bodyPreview     String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  carePlan        CarePlan?      @relation(fields: [carePlanId], references: [id])
  createdBy       User           @relation("EmailReminderCreator", fields: [createdByUserId], references: [id])
  patient         Patient        @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([carePlanId])
  @@index([sendAt])
  @@index([status])
}

model EmailHistory {
  id              String        @id @default(cuid())
  patientId       String
  sentByUserId    String
  recipientEmail  String
  subject         String
  message         String
  consultationId  String?
  carePlanId      String?
  attachmentCount Int           @default(0)
  attachmentNames String[]
  status          String        @default("SENT")
  errorMessage    String?
  sentAt          DateTime      @default(now())
  carePlan        CarePlan?     @relation(fields: [carePlanId], references: [id])
  consultation    Consultation? @relation(fields: [consultationId], references: [id])
  patient         Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  sentBy          User          @relation("EmailHistorySender", fields: [sentByUserId], references: [id])

  @@index([patientId])
  @@index([sentByUserId])
  @@index([sentAt])
  @@index([status])
}

enum UserRole {
  ADMIN
  DOCTOR
  ASSISTANT
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum AlopeciaType {
  ANDROGENETIC_ALOPECIA
  TELOGEN_EFFLUVIUM
  ALOPECIA_AREATA
  TRACTION_ALOPECIA
  SCARRING_ALOPECIA
  OTHER
}

enum ReminderType {
  CARE_PLAN_REMINDER
  FOLLOW_UP_VISIT
  LAB_RESULTS_REMINDER
}

enum ReminderStatus {
  PENDING
  SENT
  FAILED
}

enum AnnotationType {
  PROBLEM_AREA
  NOTE
  OTHER
}

enum ShapeType {
  RECT
  CIRCLE
  POLYGON
}


model EmailTemplate {
  id              String            @id @default(cuid())
  name            String
  type            EmailTemplateType
  subject         String
  htmlBody        String // Stores HTML content with placeholders like {{patientName}}
  isDefault       Boolean           @default(false)
  isActive        Boolean           @default(true)
  createdByUserId String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  createdBy       User              @relation(fields: [createdByUserId], references: [id])

  @@index([type])
  @@index([isDefault])
}

enum EmailTemplateType {
  CONSULTATION
  CARE_PLAN
  LAB_RESULT
  CUSTOM
}

model RefreshToken {
  id                String    @id @default(cuid())
  userId            String
  tokenHash         String    @unique
  expiresAt         DateTime
  revokedAt         DateTime?
  replacedByTokenId String? @unique
  createdAt         DateTime  @default(now())
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  replacedByToken   RefreshToken? @relation("TokenRotation", fields: [replacedByTokenId], references: [id])
  predecessorToken  RefreshToken? @relation("TokenRotation")

  @@index([userId])
  @@index([tokenHash])
}

model PdfJob {
  id                String       @id @default(cuid())
  type              PdfJobType
  status            PdfJobStatus @default(QUEUED)
  consultationId    String?
  carePlanId        String?
  requestedByUserId String
  filePath          String?
  errorMessage      String?
  createdAt         DateTime     @default(now())
  startedAt         DateTime?
  finishedAt        DateTime?
  carePlan          CarePlan?    @relation(fields: [carePlanId], references: [id])
  consultation      Consultation? @relation(fields: [consultationId], references: [id])
  requestedBy       User         @relation("PdfJobRequestor", fields: [requestedByUserId], references: [id])

  @@index([requestedByUserId])
  @@index([status])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  entity    String
  entityId  String?
  method    String?
  path      String?
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

enum PdfJobType {
  CONSULTATION
  CARE_PLAN
}

enum PdfJobStatus {
  QUEUED
  PROCESSING
  DONE
  FAILED
}
