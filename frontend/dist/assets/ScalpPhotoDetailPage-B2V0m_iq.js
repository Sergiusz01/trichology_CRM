import{N as pe,p as xe,r as c,q as T,j as t,B as x,T as m,I as z,P as W}from"./index-DuGlS2hS.js";import{A as N}from"./Alert-BnPrPNDn.js";import{A as fe}from"./ArrowBack-BLijn9hB.js";import{G as $}from"./Grid-9JmJah-6.js";import{B as k}from"./Button-DYA-l7Ix.js";import{E as ye}from"./Edit-CC4dElt7.js";import{S as me}from"./Save-6ATMd_0t.js";import{C as ge}from"./Cancel-CIVKDdvV.js";import{T as Q,F as je,I as we}from"./TextField-VtT5fMIl.js";import{C as be}from"./Chip-CKQ1KLG2.js";import{D as Ce}from"./Delete-XwNcIwF-.js";import{D as ve,a as Re,b as Ee,c as ze}from"./DialogTitle-Cnb6c1S1.js";import{S as Ae}from"./Select-DgRGz9X7.js";import{M as U}from"./MenuItem-0hJOb36H.js";import"./useThemeProps-CESs6Os5.js";function qe(){const{id:_,photoId:v}=pe(),V=xe(),f=c.useRef(null),j=c.useRef(null),[d,ee]=c.useState(null),[R,te]=c.useState([]),[se,q]=c.useState(!0),[H,g]=c.useState(""),[Z,w]=c.useState(""),[F,B]=c.useState(!1),[G,I]=c.useState(""),[E,A]=c.useState(!1),[l,b]=c.useState(null),[ae,M]=c.useState(!1),[K,ne]=c.useState("PROBLEM_AREA"),[L,Y]=c.useState(""),[n,C]=c.useState(null),[i,oe]=c.useState(1),[p,X]=c.useState("RECT");c.useEffect(()=>{v&&D()},[v]);const D=async()=>{var s,a;try{q(!0);const e=await T.get(`/scalp-photos/${v}`);ee(e.data.scalpPhoto),I(e.data.scalpPhoto.notes||""),te(e.data.scalpPhoto.annotations||[])}catch(e){console.error("Błąd pobierania zdjęcia:",e),g(((a=(s=e.response)==null?void 0:s.data)==null?void 0:a.error)||"Błąd pobierania zdjęcia")}finally{q(!1)}},ie=async()=>{var s,a;try{await T.put(`/scalp-photos/${v}`,{notes:G}),B(!1),w("Uwagi zapisane pomyślnie"),setTimeout(()=>w(""),3e3)}catch(e){g(((a=(s=e.response)==null?void 0:s.data)==null?void 0:a.error)||"Błąd zapisywania uwag")}},re=()=>{if(j.current&&f.current){const s=j.current,a=f.current;if(!a.getContext("2d"))return;const o=s.naturalWidth,r=s.naturalHeight,h=800,u=600,y=o/r,S=h/u;let P,O;y>S?(P=h,O=h/y):(O=u,P=u*y),a.width=P,a.height=O,oe(P/o),J()}},J=()=>{if(!j.current||!f.current)return;const s=j.current,a=f.current,e=a.getContext("2d");if(e&&(e.clearRect(0,0,a.width,a.height),e.drawImage(s,0,0,a.width,a.height),R.forEach(o=>{e.strokeStyle=o.type==="PROBLEM_AREA"?"#ff0000":"#0000ff",e.fillStyle=o.type==="PROBLEM_AREA"?"rgba(255, 0, 0, 0.2)":"rgba(0, 0, 255, 0.2)",e.lineWidth=2;const r=o.coordinates;if(o.shapeType==="RECT"){const h=r.x*i,u=r.y*i,y=(r.width||100)*i,S=(r.height||100)*i;e.fillRect(h,u,y,S),e.strokeRect(h,u,y,S),e.fillStyle="#000",e.font="14px Arial",e.fillText(o.label,h+5,u+20)}else if(o.shapeType==="CIRCLE"){const h=r.x*i,u=r.y*i,y=(r.radius||50)*i;e.beginPath(),e.arc(h,u,y,0,2*Math.PI),e.fill(),e.stroke(),e.fillStyle="#000",e.font="14px Arial",e.fillText(o.label,h-y,u-y-5)}else if(o.shapeType==="POLYGON"&&r.points){e.beginPath(),e.moveTo(r.points[0].x*i,r.points[0].y*i);for(let h=1;h<r.points.length;h++)e.lineTo(r.points[h].x*i,r.points[h].y*i);e.closePath(),e.fill(),e.stroke(),r.points.length>0&&(e.fillStyle="#000",e.font="14px Arial",e.fillText(o.label,r.points[0].x*i,r.points[0].y*i-5))}}),l&&n&&E)){if(e.strokeStyle="#00ff00",e.fillStyle="rgba(0, 255, 0, 0.2)",e.lineWidth=2,p==="RECT"){const o=Math.min(n.x,l.x),r=Math.min(n.y,l.y),h=Math.abs(l.x-n.x),u=Math.abs(l.y-n.y);e.fillRect(o,r,h,u),e.strokeRect(o,r,h,u)}else if(p==="CIRCLE"){const o=Math.sqrt(Math.pow(l.x-n.x,2)+Math.pow(l.y-n.y,2));e.beginPath(),e.arc(n.x,n.y,o,0,2*Math.PI),e.fill(),e.stroke()}}};c.useEffect(()=>{j.current&&j.current.complete&&f.current&&J()},[R,l,i,E,n,p]);const le=s=>{if(!f.current)return;const a=f.current.getBoundingClientRect(),e=s.clientX-a.left,o=s.clientY-a.top;C({x:e,y:o}),A(!0),b({x:e,y:o,shapeType:p})},ce=s=>{if(!E||!f.current||!n)return;const a=f.current.getBoundingClientRect(),e=s.clientX-a.left,o=s.clientY-a.top;b({x:e,y:o,shapeType:p})},de=()=>{if(!E||!n||!l)return;const s=10,a=Math.abs(l.x-n.x),e=Math.abs(l.y-n.y);if(p==="RECT"&&(a<s||e<s)){A(!1),C(null),b(null);return}if(p==="CIRCLE"&&Math.sqrt(Math.pow(l.x-n.x,2)+Math.pow(l.y-n.y,2))<s){A(!1),C(null),b(null);return}A(!1),M(!0)},he=async()=>{var s,a;if(!L.trim()){g("Proszę podać etykietę");return}if(!n||!l){g("Brak danych adnotacji");return}try{const e={};p==="RECT"?(e.x=Math.min(n.x,l.x)/i,e.y=Math.min(n.y,l.y)/i,e.width=Math.abs(l.x-n.x)/i,e.height=Math.abs(l.y-n.y)/i):p==="CIRCLE"&&(e.x=n.x/i,e.y=n.y/i,e.radius=Math.sqrt(Math.pow(l.x-n.x,2)+Math.pow(l.y-n.y,2))/i),await T.post(`/scalp-photos/${v}/annotations`,{type:K,shapeType:p,coordinates:e,label:L}),M(!1),b(null),C(null),Y(""),w("Adnotacja dodana pomyślnie"),setTimeout(()=>w(""),3e3),D()}catch(e){g(((a=(s=e.response)==null?void 0:s.data)==null?void 0:a.error)||"Błąd dodawania adnotacji")}},ue=async s=>{var a,e;if(window.confirm("Czy na pewno chcesz usunąć tę adnotację?"))try{await T.delete(`/scalp-photos/annotations/${s}`),w("Adnotacja usunięta pomyślnie"),setTimeout(()=>w(""),3e3),D()}catch(o){g(((e=(a=o.response)==null?void 0:a.data)==null?void 0:e.error)||"Błąd usuwania adnotacji")}};return se?t.jsx(x,{sx:{p:3},children:t.jsx(m,{children:"Ładowanie..."})}):d?t.jsxs(x,{children:[t.jsxs(x,{sx:{display:"flex",alignItems:"center",mb:2},children:[t.jsx(z,{onClick:()=>{var s;return V(_?`/patients/${_}`:(s=d==null?void 0:d.patient)!=null&&s.id?`/patients/${d.patient.id}`:"/patients")},sx:{mr:1},children:t.jsx(fe,{})}),t.jsx(m,{variant:"h4",children:"Zdjęcie skóry głowy"})]}),H&&t.jsx(N,{severity:"error",sx:{mb:2},onClose:()=>g(""),children:H}),Z&&t.jsx(N,{severity:"success",sx:{mb:2},onClose:()=>w(""),children:Z}),t.jsxs($,{container:!0,spacing:2,children:[t.jsx($,{size:{xs:12,md:8},children:t.jsx(W,{sx:{p:2},children:t.jsxs(x,{sx:{position:"relative",display:"inline-block",width:"100%"},children:[t.jsx("img",{ref:j,src:d.url||(d.filePath?`/uploads/${d.filePath.split(/[/\\]/).pop()}`:""),alt:d.originalFilename||"Zdjęcie skóry głowy",onLoad:()=>{console.log("Obraz załadowany:",d.url||d.filePath),re()},onError:s=>{const a=s.target;console.error("Błąd ładowania obrazu:",{src:a.src,url:d.url,filePath:d.filePath,photo:d}),g(`Nie można załadować obrazu: ${d.url||d.filePath}`)},style:{maxWidth:"100%",height:"auto",display:"none",imageOrientation:"from-image"}}),t.jsx("canvas",{ref:f,style:{border:"1px solid #ccc",cursor:E?"crosshair":"default",maxWidth:"100%",height:"auto"},onMouseDown:le,onMouseMove:ce,onMouseUp:de}),t.jsxs(x,{sx:{mt:1,display:"flex",gap:1,flexWrap:"wrap",alignItems:"center"},children:[t.jsx(m,{variant:"body2",sx:{mr:1},children:"Wybierz kształt:"}),t.jsx(k,{variant:p==="RECT"?"contained":"outlined",size:"small",onClick:()=>{X("RECT"),b(null),C(null)},children:"Prostokąt"}),t.jsx(k,{variant:p==="CIRCLE"?"contained":"outlined",size:"small",onClick:()=>{X("CIRCLE"),b(null),C(null)},children:"Koło"}),t.jsx(m,{variant:"caption",color:"text.secondary",sx:{ml:2},children:"Kliknij i przeciągnij na zdjęciu, aby dodać adnotację"})]})]})})}),t.jsxs($,{size:{xs:12,md:4},children:[t.jsxs(W,{sx:{p:2,mb:2},children:[t.jsxs(x,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[t.jsx(m,{variant:"h6",children:"Uwagi"}),F?t.jsxs(x,{children:[t.jsx(z,{size:"small",onClick:ie,color:"primary",children:t.jsx(me,{})}),t.jsx(z,{size:"small",onClick:()=>{B(!1),I(d.notes||"")},children:t.jsx(ge,{})})]}):t.jsx(z,{size:"small",onClick:()=>B(!0),children:t.jsx(ye,{})})]}),F?t.jsx(Q,{fullWidth:!0,multiline:!0,rows:4,value:G,onChange:s=>I(s.target.value),placeholder:"Dodaj uwagi do zdjęcia..."}):t.jsx(m,{variant:"body2",color:"text.secondary",children:d.notes||"Brak uwag"})]}),t.jsxs(W,{sx:{p:2},children:[t.jsxs(m,{variant:"h6",gutterBottom:!0,children:["Adnotacje (",R.length,")"]}),R.length===0?t.jsx(m,{variant:"body2",color:"text.secondary",children:"Brak adnotacji. Kliknij i przeciągnij na zdjęciu, aby dodać."}):t.jsx(x,{sx:{display:"flex",flexDirection:"column",gap:1},children:R.map(s=>t.jsxs(x,{sx:{p:1,border:"1px solid #ddd",borderRadius:1,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsxs(x,{children:[t.jsx(be,{label:s.type==="PROBLEM_AREA"?"Obszar problemowy":"Uwaga",size:"small",color:s.type==="PROBLEM_AREA"?"error":"primary",sx:{mr:1}}),t.jsx(m,{variant:"body2",children:s.label}),t.jsx(m,{variant:"caption",color:"text.secondary",children:new Date(s.createdAt).toLocaleDateString("pl-PL")})]}),t.jsx(z,{size:"small",color:"error",onClick:()=>ue(s.id),children:t.jsx(Ce,{})})]},s.id))})]})]})]}),t.jsxs(ve,{open:ae,onClose:()=>M(!1),children:[t.jsx(Re,{children:"Dodaj adnotację"}),t.jsxs(Ee,{children:[t.jsxs(je,{fullWidth:!0,sx:{mt:2,mb:2},children:[t.jsx(we,{children:"Typ"}),t.jsxs(Ae,{value:K,onChange:s=>ne(s.target.value),label:"Typ",children:[t.jsx(U,{value:"PROBLEM_AREA",children:"Obszar problemowy"}),t.jsx(U,{value:"NOTE",children:"Uwaga"}),t.jsx(U,{value:"OTHER",children:"Inne"})]})]}),t.jsx(Q,{fullWidth:!0,label:"Etykieta",value:L,onChange:s=>Y(s.target.value),placeholder:"np. Łuszczenie, Zaczerwienie...",required:!0})]}),t.jsxs(ze,{children:[t.jsx(k,{onClick:()=>M(!1),children:"Anuluj"}),t.jsx(k,{onClick:he,variant:"contained",children:"Zapisz"})]})]})]}):t.jsx(x,{sx:{p:3},children:t.jsx(N,{severity:"error",children:"Zdjęcie nie znalezione"})})}export{qe as default};
