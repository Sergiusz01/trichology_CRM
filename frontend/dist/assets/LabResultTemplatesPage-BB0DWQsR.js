import{r as h,j as e,B as d,T as f,P as N,I as E,q as D,S as Y,C as Q,L as V,a2 as ee,w as se,a3 as ne}from"./index-ik9JjyS6.js";import{u as O}from"./useNotification-DgBW3D1z.js";import{G as x}from"./Grid-OOY2WAvo.js";import{T as b,F as le,I as te}from"./TextField-BNTsiTHM.js";import{F as ae,a as re}from"./Switch-CMxXGKKJ.js";import{B as z}from"./Button-B6n5coYQ.js";import{A as H}from"./Add-BfAxRG2-.js";import{A as M}from"./Alert-Dzq7_ew3.js";import{S as W}from"./Stack-DcOE3fMJ.js";import{D as ie}from"./DragIndicator-DX-HaPvZ.js";import{C as U}from"./Chip-pTV9ioJu.js";import{E as K}from"./Edit-DimIYhJX.js";import{D as A}from"./Delete-rK6RFrLt.js";import{D as P,a as oe,b as _,c as ce}from"./DialogTitle-DX1gnFsJ.js";import{S as de}from"./Select--zggdXop.js";import{M as ue}from"./MenuItem-cD7WzH5Q.js";import"./useThemeProps-C_QfMg4i.js";const F=[{value:"NUMBER",label:"Liczba (wynik + jednostka + ref.)"},{value:"TEXT",label:"Tekst"},{value:"SELECT",label:"Wybór z listy"}];function xe({template:r,onSave:L,onCancel:T}){const[v,I]=h.useState((r==null?void 0:r.name)??""),[a,k]=h.useState((r==null?void 0:r.fields)??[]),[y,w]=h.useState((r==null?void 0:r.isDefault)??!1),[p,m]=h.useState(null),[B,g]=h.useState(!1),[n,i]=h.useState({type:"NUMBER",label:"",key:"",order:a.length}),{error:l}=O(),c=()=>{i({type:"NUMBER",label:"",key:"",order:a.length}),m(null),g(!0)},u=s=>{i(a[s]),m(s),g(!0)},C=s=>{const t=a.filter((o,j)=>j!==s).map((o,j)=>({...o,order:j}));k(t)},$=()=>{var o,j,R;if(!((o=n.label)!=null&&o.trim())){l("Etykieta jest wymagana");return}if(!((j=n.key)!=null&&j.trim())){l("Klucz jest wymagany");return}if(!/^[a-zA-Z0-9_]+$/.test(n.key)){l("Klucz: tylko litery, cyfry, podkreślenia");return}const s=a.map(S=>S.key);if(p!==null){if(s.filter((he,X)=>X!==p).includes(n.key)){l("Klucz musi być unikalny");return}}else if(s.includes(n.key)){l("Klucz musi być unikalny");return}if(n.type==="SELECT"&&(!n.options||n.options.length===0)){l("SELECT wymaga co najmniej jednej opcji");return}const t={type:n.type??"NUMBER",label:n.label.trim(),key:n.key.trim(),unit:n.unit||void 0,refLow:n.refLow,refHigh:n.refHigh,order:n.order??a.length,options:(R=n.options)==null?void 0:R.filter(Boolean)};if(p!==null){const S=[...a];S[p]=t,k(S)}else k([...a,t]);g(!1),i({type:"NUMBER",label:"",key:"",order:a.length+1}),m(null)},q=()=>{if(!v.trim()){l("Nazwa szablonu jest wymagana");return}if(a.length===0){l("Szablon musi zawierać co najmniej jedno pole");return}L({id:r==null?void 0:r.id,name:v.trim(),fields:a.slice().sort((s,t)=>s.order-t.order),isDefault:y,isActive:!0})},Z=(s,t)=>{const o=[...n.options||[]];o[s]=t,i({...n,options:o})},G=()=>{i({...n,options:[...n.options||[],""]})},J=s=>{const t=(n.options||[]).filter((o,j)=>j!==s);i({...n,options:t})};return e.jsxs(d,{sx:{p:3},children:[e.jsx(f,{variant:"h5",sx:{mb:3,fontWeight:"bold"},children:r!=null&&r.id?"Edytuj szablon wyników badań":"Nowy szablon wyników badań"}),e.jsx(N,{sx:{p:3,mb:3},children:e.jsxs(x,{container:!0,spacing:2,children:[e.jsx(x,{size:{xs:12},children:e.jsx(b,{fullWidth:!0,label:"Nazwa szablonu",value:v,onChange:s=>I(s.target.value),required:!0})}),e.jsx(x,{size:{xs:12},children:e.jsx(ae,{control:e.jsx(re,{checked:y,onChange:s=>w(s.target.checked)}),label:"Ustaw jako domyślny"})})]})}),e.jsxs(d,{sx:{mb:2,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(f,{variant:"h6",children:"Pola (parametry badań)"}),e.jsx(z,{variant:"contained",startIcon:e.jsx(H,{}),onClick:c,children:"Dodaj pole"})]}),a.length===0?e.jsx(M,{severity:"info",sx:{mb:2},children:"Brak pól. Kliknij „Dodaj pole”, np. Cynk, Selen, Testosteron, DHEA-S itd."}):e.jsx(W,{spacing:2,children:a.slice().sort((s,t)=>s.order-t.order).map((s,t)=>{var o;return e.jsx(N,{sx:{p:2},children:e.jsxs(d,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[e.jsxs(d,{sx:{flex:1},children:[e.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1,mb:1},children:[e.jsx(ie,{sx:{color:"text.secondary"}}),e.jsx(f,{variant:"subtitle1",fontWeight:"bold",children:s.label}),e.jsx(U,{label:((o=F.find(j=>j.value===s.type))==null?void 0:o.label)??s.type,size:"small",color:"primary",variant:"outlined"})]}),e.jsxs(f,{variant:"body2",color:"text.secondary",children:["Klucz: ",e.jsx("code",{children:s.key}),s.unit&&` • Jednostka: ${s.unit}`,(s.refLow!=null||s.refHigh!=null)&&` • Ref.: ${s.refLow??"?"} – ${s.refHigh??"?"}`]})]}),e.jsxs(d,{children:[e.jsx(E,{color:"primary",onClick:()=>u(t),children:e.jsx(K,{})}),e.jsx(E,{color:"error",onClick:()=>C(t),children:e.jsx(A,{})})]})]})},t)})}),e.jsxs(P,{open:B,onClose:()=>g(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(oe,{children:p!==null?"Edytuj pole":"Dodaj pole"}),e.jsx(_,{children:e.jsxs(x,{container:!0,spacing:2,sx:{mt:.5},children:[e.jsx(x,{size:{xs:12},children:e.jsx(b,{fullWidth:!0,label:"Etykieta",value:n.label??"",onChange:s=>i({...n,label:s.target.value}),required:!0,placeholder:"np. Cynk, Selen, Testosteron"})}),e.jsx(x,{size:{xs:12},children:e.jsx(b,{fullWidth:!0,label:"Klucz (bez spacji, tylko a–z, 0–9, _)",value:n.key??"",onChange:s=>i({...n,key:s.target.value}),required:!0,placeholder:"np. zinc, selenium, testosterone"})}),e.jsx(x,{size:{xs:12},children:e.jsxs(le,{fullWidth:!0,children:[e.jsx(te,{children:"Typ"}),e.jsx(de,{value:n.type??"NUMBER",label:"Typ",onChange:s=>i({...n,type:s.target.value}),children:F.map(s=>e.jsx(ue,{value:s.value,children:s.label},s.value))})]})}),(n.type==="NUMBER"||!n.type)&&e.jsxs(e.Fragment,{children:[e.jsx(x,{size:{xs:12,sm:4},children:e.jsx(b,{fullWidth:!0,label:"Jednostka (domyślnie)",value:n.unit??"",onChange:s=>i({...n,unit:s.target.value||void 0}),placeholder:"np. ng/mL"})}),e.jsx(x,{size:{xs:12,sm:4},children:e.jsx(b,{fullWidth:!0,type:"number",label:"Ref. dolna",value:n.refLow??"",onChange:s=>i({...n,refLow:s.target.value===""?void 0:Number(s.target.value)})})}),e.jsx(x,{size:{xs:12,sm:4},children:e.jsx(b,{fullWidth:!0,type:"number",label:"Ref. górna",value:n.refHigh??"",onChange:s=>i({...n,refHigh:s.target.value===""?void 0:Number(s.target.value)})})})]}),n.type==="SELECT"&&e.jsxs(x,{size:{xs:12},children:[e.jsx(f,{variant:"subtitle2",gutterBottom:!0,children:"Opcje"}),e.jsxs(W,{direction:"row",flexWrap:"wrap",gap:1,children:[(n.options??[]).map((s,t)=>e.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(b,{size:"small",value:s,onChange:o=>Z(t,o.target.value),placeholder:"Opcja",sx:{width:140}}),e.jsx(E,{size:"small",onClick:()=>J(t),children:e.jsx(A,{fontSize:"small"})})]},t)),e.jsx(z,{size:"small",onClick:G,children:"+ Opcja"})]})]})]})}),e.jsxs(ce,{children:[e.jsx(z,{onClick:()=>g(!1),children:"Anuluj"}),e.jsx(z,{variant:"contained",onClick:$,children:p!==null?"Zapisz":"Dodaj"})]})]}),e.jsxs(d,{sx:{display:"flex",gap:2,mt:4},children:[e.jsx(z,{variant:"outlined",onClick:T,children:"Anuluj"}),e.jsx(z,{variant:"contained",onClick:q,children:"Zapisz szablon"})]})]})}function Ie(){const[r,L]=h.useState([]),[T,v]=h.useState(!0),[I,a]=h.useState(!1),[k,y]=h.useState(null),{success:w,error:p}=O();h.useEffect(()=>{m()},[]);const m=async()=>{var l,c;try{v(!0);const u=await D.get("/lab-result-templates");L(u.data.templates||[])}catch(u){p(((c=(l=u.response)==null?void 0:l.data)==null?void 0:c.error)||"Błąd pobierania szablonów")}finally{v(!1)}},B=()=>{y(null),a(!0)},g=l=>{y(l),a(!0)},n=async l=>{var c,u;if(window.confirm("Czy na pewno chcesz usunąć ten szablon?"))try{await D.delete(`/lab-result-templates/${l}`),w("Szablon usunięty"),m()}catch(C){p(((u=(c=C.response)==null?void 0:c.data)==null?void 0:u.error)||"Błąd usuwania szablonu")}},i=async l=>{var c,u;try{l.id?(await D.put(`/lab-result-templates/${l.id}`,l),w("Szablon zaktualizowany")):(await D.post("/lab-result-templates",l),w("Szablon utworzony")),a(!1),y(null),m()}catch(C){p(((u=(c=C.response)==null?void 0:c.data)==null?void 0:u.error)||"Błąd zapisywania szablonu")}};return e.jsxs(d,{sx:{p:3},children:[e.jsxs(d,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(f,{variant:"h4",sx:{fontWeight:"bold",display:"flex",alignItems:"center",gap:1},children:[e.jsx(Y,{}),"Zarządzaj szablonami badań"]}),e.jsx(z,{variant:"contained",startIcon:e.jsx(H,{}),onClick:B,children:"Nowy szablon"})]}),T?e.jsx(d,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx(Q,{})}):r.length===0?e.jsx(M,{severity:"info",children:"Brak szablonów. Kliknij „Nowy szablon”, aby dodać np. Cynk, Selen, Testosteron, DHEA-S."}):e.jsx(V,{children:r.sort((l,c)=>l.isDefault&&!c.isDefault?-1:!l.isDefault&&c.isDefault?1:0).map(l=>e.jsx(N,{sx:{mb:2},children:e.jsxs(ee,{children:[e.jsx(se,{primary:e.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(f,{variant:"h6",children:l.name}),l.isDefault&&e.jsx(U,{label:"Domyślny",color:"primary",size:"small"})]}),secondary:e.jsxs(f,{variant:"body2",color:"text.secondary",children:[(l.fields||[]).length," ",(l.fields||[]).length===1?"pole":"pól"]})}),e.jsx(ne,{children:e.jsxs(W,{direction:"row",spacing:1,children:[e.jsx(E,{edge:"end",color:"primary",onClick:()=>g(l),title:"Edytuj",children:e.jsx(K,{})}),!l.isDefault&&l.id&&e.jsx(E,{edge:"end",color:"error",onClick:()=>n(l.id),title:"Usuń",children:e.jsx(A,{})})]})})]})},l.id))}),e.jsx(P,{open:I,onClose:()=>{a(!1),y(null)},maxWidth:"lg",fullWidth:!0,PaperProps:{sx:{height:"90vh",maxHeight:"90vh"}},children:e.jsx(_,{sx:{p:0,overflow:"auto"},children:e.jsx(xe,{template:k,onSave:i,onCancel:()=>{a(!1),y(null)}})})})]})}export{Ie as default};
