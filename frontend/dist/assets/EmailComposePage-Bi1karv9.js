import{c as Q,j as e,O as _,p as J,n as U,o as X,r as o,q as j,B as f,I as B,T as x,P as Y,L as ee,a2 as se,x as ae,w as te}from"./index-ik9JjyS6.js";import{C as ie}from"./Container-U9Ph7Onl.js";import{A as ne}from"./ArrowBack-CNB7SP5c.js";import{A as E}from"./Alert-Dzq7_ew3.js";import{G as c}from"./Grid-OOY2WAvo.js";import{T as I,F as T,I as A}from"./TextField-BNTsiTHM.js";import{S as L}from"./Select--zggdXop.js";import{M as g}from"./MenuItem-cD7WzH5Q.js";import{B as S}from"./Button-B6n5coYQ.js";import{D as re}from"./Delete-rK6RFrLt.js";import{S as oe}from"./Send-CFne59d_.js";import"./useThemeProps-C_QfMg4i.js";const $=Q(e.jsx("path",{d:"M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6z"}));function ye(){const{id:l}=_(),b=J(),Z=U(),d=X(Z.breakpoints.down("sm")),[y,z]=o.useState(!1),[P,h]=o.useState(""),[k,v]=o.useState(""),[m,R]=o.useState(null),[w,M]=o.useState([]),[W,q]=o.useState([]),[a,D]=o.useState({subject:"",message:"",recipientEmail:"",attachConsultationId:"",attachCarePlanId:""}),[C,F]=o.useState([]),[V]=o.useState(0);o.useEffect(()=>{l&&N()},[l]);const N=async()=>{var s,i,n;try{const u=(await j.get(`/patients/${l}`)).data.patient;R(u),D(r=>({...r,recipientEmail:u.email||""}));try{const r=await j.get(`/consultations/patient/${l}`);M(r.data.consultations||[])}catch(r){console.error("Błąd pobierania konsultacji:",r)}try{const r=await j.get(`/care-plans/patient/${l}`);q(((s=r.data)==null?void 0:s.carePlans)||r.data||[])}catch(r){console.error("Błąd pobierania planów opieki:",r)}}catch(t){h(((n=(i=t.response)==null?void 0:i.data)==null?void 0:n.error)||"Błąd pobierania danych pacjenta")}},p=(s,i)=>{D(n=>({...n,[s]:i}))},G=s=>{if(s.target.files){const i=Array.from(s.target.files);F(n=>[...n,...i])}},K=s=>{F(i=>i.filter((n,t)=>t!==s))},H=async s=>{var i,n;s.preventDefault(),h(""),v(""),z(!0);try{const t=new FormData;t.append("patientId",l),t.append("subject",a.subject),t.append("message",a.message),a.recipientEmail&&t.append("recipientEmail",a.recipientEmail),a.attachConsultationId&&t.append("attachConsultationId",a.attachConsultationId),a.attachCarePlanId&&t.append("attachCarePlanId",a.attachCarePlanId),C.forEach(u=>{t.append("attachments",u)}),await j.post("/email/send",t,{headers:{"Content-Type":"multipart/form-data"}}),v("Email wysłany pomyślnie!"),setTimeout(()=>{b(`/patients/${l}`)},2e3)}catch(t){h(((n=(i=t.response)==null?void 0:i.data)==null?void 0:n.error)||"Błąd wysyłania emaila")}finally{z(!1)}},O=s=>`${new Date(s.consultationDate).toLocaleDateString("pl-PL")}${s.diagnosis?` - ${s.diagnosis}`:""}`;return e.jsx(f,{sx:{width:"100%",maxWidth:"100%",overflow:"hidden"},children:e.jsxs(ie,{maxWidth:"lg",sx:{py:{xs:2,sm:4},px:{xs:1,sm:3}},children:[e.jsxs(f,{sx:{mb:{xs:2,sm:3},display:"flex",alignItems:"center",gap:2,flexWrap:"wrap"},children:[e.jsx(B,{onClick:()=>b(`/patients/${l}`),sx:{bgcolor:"action.hover","&:hover":{bgcolor:"action.selected"}},children:e.jsx(ne,{})}),e.jsx(x,{variant:"h4",sx:{fontSize:{xs:"1.5rem",sm:"2rem"},fontWeight:600,flex:1},children:"Wyślij email do pacjenta"})]}),m&&e.jsxs(x,{variant:"body1",color:"text.secondary",sx:{mb:{xs:2,sm:3},px:{xs:1,sm:0}},children:["Pacjent: ",e.jsxs("strong",{children:[m.firstName," ",m.lastName]})]}),P&&e.jsx(E,{severity:"error",sx:{mb:2,mx:{xs:1,sm:0}},onClose:()=>h(""),children:P}),k&&e.jsx(E,{severity:"success",sx:{mb:2,mx:{xs:1,sm:0}},onClose:()=>v(""),children:k}),e.jsx(Y,{sx:{p:{xs:2,sm:3},borderRadius:3,border:"1px solid",borderColor:"divider"},children:e.jsx("form",{onSubmit:H,children:e.jsxs(c,{container:!0,spacing:{xs:2,sm:3},children:[e.jsx(c,{size:{xs:12},children:e.jsx(I,{fullWidth:!0,required:!0,label:"Adres email odbiorcy",type:"email",value:a.recipientEmail,onChange:s=>p("recipientEmail",s.target.value),helperText:!(m!=null&&m.email)&&"Pacjent nie ma zapisanego adresu email"})}),e.jsx(c,{size:{xs:12},children:e.jsx(I,{fullWidth:!0,required:!0,label:"Temat",value:a.subject,onChange:s=>p("subject",s.target.value),placeholder:"np. Zalecenia po konsultacji, Plan opieki, Wyniki badań"})}),e.jsx(c,{size:{xs:12},children:e.jsx(I,{fullWidth:!0,required:!0,label:"Treść wiadomości",multiline:!0,rows:d?8:10,value:a.message,onChange:s=>p("message",s.target.value),placeholder:"Wpisz treść wiadomości do pacjenta..."})}),e.jsx(c,{size:{xs:12},children:e.jsx(x,{variant:"h6",sx:{fontSize:{xs:"1rem",sm:"1.25rem"},fontWeight:600,mb:1},children:"Załączniki z systemu"})}),w.length>0&&e.jsx(c,{size:{xs:12,md:6},children:e.jsxs(T,{fullWidth:!0,children:[e.jsx(A,{children:"Załącz konsultację (PDF)"}),e.jsxs(L,{value:a.attachConsultationId,onChange:s=>p("attachConsultationId",s.target.value),label:"Załącz konsultację (PDF)",children:[e.jsx(g,{value:"",children:"Brak"}),w.map(s=>e.jsx(g,{value:s.id,children:O(s)},s.id))]})]})}),W.length>0&&e.jsx(c,{size:{xs:12,md:6},children:e.jsxs(T,{fullWidth:!0,children:[e.jsx(A,{children:"Załącz plan opieki (PDF)"}),e.jsxs(L,{value:a.attachCarePlanId,onChange:s=>p("attachCarePlanId",s.target.value),label:"Załącz plan opieki (PDF)",children:[e.jsx(g,{value:"",children:"Brak"}),W.map(s=>e.jsxs(g,{value:s.id,children:[s.title," (",s.totalDurationWeeks," tygodni)"]},s.id))]})]})}),e.jsxs(c,{size:{xs:12},children:[e.jsx(x,{variant:"h6",sx:{fontSize:{xs:"1rem",sm:"1.25rem"},fontWeight:600,mt:{xs:1,sm:2},mb:1},children:"Załączniki plików"}),e.jsxs(f,{sx:{mb:2},children:[e.jsx("input",{type:"file",multiple:!0,onChange:G,style:{display:"none"},id:"file-upload"},V),e.jsx("label",{htmlFor:"file-upload",children:e.jsx(S,{variant:"outlined",component:"span",startIcon:e.jsx($,{}),fullWidth:d,sx:{mr:{xs:0,sm:2},mb:{xs:1,sm:0}},children:"Dodaj pliki"})})]}),C.length>0&&e.jsx(ee,{sx:{p:0},children:C.map((s,i)=>e.jsxs(se,{sx:{px:{xs:1,sm:2},py:{xs:1,sm:1.5},border:"1px solid",borderColor:"divider",borderRadius:2,mb:1},secondaryAction:e.jsx(B,{edge:"end",onClick:()=>K(i),color:"error",size:d?"small":"medium",children:e.jsx(re,{})}),children:[e.jsx(ae,{sx:{minWidth:{xs:36,sm:40}},children:e.jsx($,{fontSize:d?"small":"medium"})}),e.jsx(te,{primary:e.jsx(x,{variant:d?"body2":"body1",sx:{wordBreak:"break-word",pr:{xs:4,sm:6}},children:s.name}),secondary:e.jsxs(x,{variant:"caption",color:"text.secondary",children:[(s.size/1024).toFixed(2)," KB"]})})]},i))})]}),e.jsx(c,{size:{xs:12},children:e.jsxs(f,{sx:{display:"flex",gap:2,justifyContent:{xs:"stretch",sm:"flex-end"},flexDirection:{xs:"column",sm:"row"},mt:{xs:1,sm:2}},children:[e.jsx(S,{variant:"outlined",onClick:()=>b(`/patients/${l}`),disabled:y,fullWidth:d,children:"Anuluj"}),e.jsx(S,{type:"submit",variant:"contained",startIcon:e.jsx(oe,{}),disabled:y||!a.subject||!a.message,fullWidth:d,sx:{bgcolor:"#1976d2","&:hover":{bgcolor:"#1565c0"}},children:y?"Wysyłanie...":"Wyślij email"})]})})]})})})]})})}export{ye as default};
